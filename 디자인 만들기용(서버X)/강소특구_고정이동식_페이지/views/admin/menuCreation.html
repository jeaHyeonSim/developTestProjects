<!DOCTYPE html>
<html lang="ko">

	<head>
		<%-include('partials/header.html') %>
	</head>
	
	<body>
		<div class="wrapper">
			<%-include('partials/sideBar.html') %>

			<div class="main">
				<%-include('partials/navigation.html') %>

			<main class="content">
				<div class="container-fluid p-0">
					<nav aria-label="breadcrumb">
						<ol class="breadcrumb">
						  <li class="right-items"><h1 class="h3"><strong></strong>메뉴 뷰 관리</h1></li>
						  <li class="breadcrumb-item">시스템 관리</li>
						  <li class="breadcrumb-item">메뉴 관리</li>
						  <li class="breadcrumb-item" aria-current="page">메뉴 뷰 관리</li>
						</ol>
					</nav>


                    <div class="row">
                        <div class="card">
							<div class="card-header">
									<div class="row border-bottom-line">
										<div class="mb-3 col-2 col-xl-2">
											<select class="form-select" id="searchSelect">
												<option value="all" <%if(DTO.select === 'all') {%> selected <%}%>>검색조건</option>
												<option value="code" <%if(DTO.select === 'code') {%> selected <%}%>>권한코드</option>
												<option value="name" <%if(DTO.select === 'name') {%> selected <%}%>>권한명</option>
											</select>
										</div>
										<div class="mb-3 col-3 col-xl-3">
											<input type="text" onkeyup="enterkey();" class="form-control" id="searchContent" name="searchContent" placeholder="검색 내용을 입력주세요" value="<%=DTO.content%>">
										</div>
										<div class="mb-3 col-3 col-xl-3">
										</div>
										<div class="mb-3 col-4 col-xl-4 d-flex justify-content-end">
											<form name="searchform" method="get">
												<input type="hidden" id="currentPage" name ="currentPage">
												<input type="hidden" id="pageMove" name ="pageMove">
												<input type="hidden" id="select" name ="select">
												<input type="hidden" id="content" name ="content">
												<button class="ml-1 btn btn-primary btn-mg" onclick="javascript:movePage(''); return false;"><i class="align-middle" data-feather="search"></i> 조회</button>
												<button class="ml-1 btn btn-primary btn-mg" onclick="javascript:init(); return false;"><i class="align-middle" data-feather="rotate-ccw"></i> 초기화</button>
											</form>
										</div>
									</div>
							</div>
							<h6 class="card-subtitle text-muted">
								<p class="text-start"></p>
								<p class="text-end">검색결과: <Strong><%=pageVO.getTotal()%></Strong>건, &nbsp;<Strong><%=pageVO.getCurrentPage()%>/<%=pageVO.getTotalPages()%></Strong> 페이지</p>
							</h6>
							<table class="table table-striped table-bordered text-center">
								<colgroup>
									<col width="3%">
									<col width="10%">
									<col width="10%">
									<col width="10%">
									<col width="7%">
									<col width="7%">
								</colgroup>
								<thead>
									<tr>
										<th>번호</th>
										<th>권한코드</th>
										<th>권한명</th>
										<th>설명</th>
										<th>메뉴생성여부</th>
										<th>관리</th>
									</tr>
								</thead>
								<tbody>
									<% for(var i = 0; i < list.length; i++){ %>
										<tr>
											<td><%=(((pageVO.getCurrentPage() - 1) * pageVO.getSize()) + i + 1)%></td>
											<td><%=list[i].AUTHOR_CODE%></td>
											<td><%=list[i].AUTHOR_NM%></td>
											<td><%=list[i].AUTHOR_DC%></td>
											<td>
												<% if (list[i].CHK_YN == 'Y') { %>
													생성
												<% } else { %>
													미생성
												<% } %>
											</td>
											<td>
												<button class="btn btn-primary btn-sm" onclick="createMenu(this); return false;" style="font-size: .4rem;" data-authcode="<%=list[i].AUTHOR_CODE%>">
													<i class="align-middle" data-feather="plus-circle"></i>
													메뉴 숨김/보이기
												</button>
											</td>
										</tr>
									<% } %>
									<% if (list.length == 0) { %>
										<tr>
											<td style="text-align: center;" colspan="6">
												데이터가 존재하지 않습니다.
											</td>
										</tr>
									<% } %>
								</tbody>
							</table>
							<%-include('partials/paging.html') %>
						</div>
                    </div>

					<!-- 롤정보 -->
					<div class="modal fade" id="defaultModalPrimary" tabindex="-1" aria-hidden="true">
						<div class="modal-dialog" role="document">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title ml-1">
										<h4>메뉴 숨김/보이기</h4>
									</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
								</div>
								<div class="modal-body">

									<div class="card">
										<div class="card-body">
											<div class="mb-3 form-group row">
												<label for="authCode" class="col-sm-3 col-form-label"><strong>권한코드</strong></label>
												<div class="col-sm-9 text-center"><input id="authCode" type="text" class="form-control disabled"></div>
											</div>
											<div class="form-group row">
												<div class="col-sm-12 d-flex justify-content-end">
													<button type="button" class="btn btn-primary" onclick="updateMenu(); return false;"><i class="align-middle" data-feather="save"></i> 저장</button>
												</div>
											</div>
											<div class="form-group row">
												<div class="col-sm-12">
													<div id="treeview-checkable" class="treeview">
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>


				</div>
			</main>

			<footer class="footer">
				<%-include('partials/footer.html') %>
			</footer>
		</div>
	</div>

	<script>
		function createMenu(obj){
			$("#defaultModalPrimary").modal('toggle');
			$("#authCode").val($(obj).data("authcode"));
			getTreeData();
		}

		function init() {
			$("#searchSelect").val("all");
			$("#searchContent").val("");
			movePage('');
		}

		function movePage(curPage) {
			document.searchform.currentPage.value = curPage;
			document.searchform.select.value = $("#searchSelect").val().trim();
			document.searchform.content.value = $("#searchContent").val().trim();
			document.searchform.submit();
		}

		function movePagePreNext(curPage, pageState) {
			document.searchform.pageMove.value = pageState;
			document.searchform.currentPage.value = curPage;
			document.searchform.select.value = $("#searchSelect").val().trim();
			document.searchform.conetnt.value = $("#searchContent").val().trim();
			document.searchform.submit();
		}

		function enterkey() {
			if (window.event.keyCode == 13) {
				movePage('');
    		}
		}
		function treeRecursive(tree, data, level) {
			if(data.LEVEL == 1) return;	// root 건너뜀.

			if(data.LEVEL == level) {
				tree.push({
					text: "[lvl. "+(parseInt(level)-1)+"]  " + data.MENU_NM,
					nodes: [],
					upperNo: data.UPPER_MENU_NO,
					menuNo: data.MENU_NO
				});
			} else {
				var lastTreeNode = tree[tree.length -1].nodes; 
				treeRecursive(lastTreeNode, data, level + 1);
			}
		}

		function getTreeData() {
		$.ajax({
				type:"get",
				url:"/manage/menucreation/menulist",
				dataType: 'json',
				data : {
					authCode : $("#authCode").val()
				},success : function(data){

					var tree =[];
					for (let index = 0; index < data.list.length; index++) {
						treeRecursive(tree, data.list[index], 2);
					}	

					$('#treeview-checkable').treeview({
						color: "#333333",
						expandIcon: "glyphicon glyphicon-menu-down",
						collapseIcon : "glyphicon glyphicon-menu-right",
						// selectedColor: "while",
						// selectedBackColor: "while",
						showCheckbox: true,
						highlightSelected:false,
						state: {
							expanded: true
						},
						data: tree,
					});

					$('#treeview-checkable').treeview('expandAll');
					$('#treeview-checkable').css("height", "500px");
					$('#treeview-checkable').css("overflow", "auto");
					// $('#treeview-checkable').css("border", "1px solid lightblue");

					// 모듈 자체가.. 이상함.
					$("#treeview-checkable").on("nodeSelected", function(event, data) {
						$("#treeview-checkable").treeview("toggleNodeChecked",[data.nodeId, {silent: true}]);
					});

					for (let index = 0; index < data.checkList.length; index++) {
						checkListMenuNo = data.checkList[index].MENU_NO;
						
						var length = $($("#treeview-checkable > ul li")).length;
						for (let index = 0; index < length; index++) {
							var nodeId = $($($("#treeview-checkable > ul li")).get(index)).data("nodeid");
							var nodeContent = $("#treeview-checkable").treeview("getNode", nodeId);

							if(nodeContent.menuNo == checkListMenuNo) {
								$("#treeview-checkable").treeview("checkNode",[nodeId]);
							}
						}
					}

				}, error : function() {
				}
			});
		}

		function updateMenu() {
			var menuArr = [];
			var length = $($("#treeview-checkable > ul li")).length;

			for (let index = 0; index < length; index++) {
				var nodeId = $($($("#treeview-checkable > ul li")).get(index)).data("nodeid");
				var nodeContent = $("#treeview-checkable").treeview("getNode", nodeId);
				if(nodeContent.state.checked) {
					menuArr.push(nodeContent.menuNo);
				}
			}
			console.log( {
					authCode : $("#authCode").val(),
					menuArr : menuArr
				})
			$.ajax({
				type:"put",
				url:"/manage/menucreation/updatemenu",
				dataType: 'json',
				data : {
					authCode : $("#authCode").val(),
					menuArr : JSON.stringify(menuArr)
				},success : function(data){
					alert("등록되었습니다.");
				}, error : function() {}
			});
		}
	</script>


</body>

</html>