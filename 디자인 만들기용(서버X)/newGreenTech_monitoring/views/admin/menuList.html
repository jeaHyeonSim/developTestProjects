<!DOCTYPE html>
<html lang="ko">

	<head>
		<%-include('partials/header.html') %>
	</head>
	
	<body>
		<div class="wrapper">
			<%-include('partials/sideBar.html') %>

			<div class="main">
				<%-include('partials/navigation.html') %>

			<main class="content">
				<div class="container-fluid p-0">
					<nav aria-label="breadcrumb">
						<ol class="breadcrumb">
						  <li class="right-items"><h1 class="h3"><strong></strong>메뉴 생성</h1></li>
						  <li class="breadcrumb-item">시스템 관리</li>
						  <li class="breadcrumb-item">메뉴 관리</li>
						  <li class="breadcrumb-item" aria-current="page">메뉴 생성</li>
						</ol>
					</nav>
                    <div class="row">
                        <div class="card">
							<div class="card-header">
									<div class="row border-bottom-line">
										<div class="mb-3 col-2 col-xl-2">
											<select class="form-select" id="searchSelect">
												<option value="all" <%if(DTO.select === 'all') {%> selected <%}%>>검색조건</option>
												<option value="upperNo" <%if(DTO.select === 'upperNo') {%> selected <%}%>>상위메뉴번호</option>
												<option value="menuNo" <%if(DTO.select === 'menuNo') {%> selected <%}%>>메뉴번호</option>
												<option value="menuNm" <%if(DTO.select === 'menuNm') {%> selected <%}%>>메뉴명</option>
											</select>
										</div>
										<div class="mb-3 col-3 col-xl-3">
											<input type="text" onkeyup="enterkey();" class="form-control" id="searchContent" name="searchContent" placeholder="검색 내용을 입력주세요" value="<%=DTO.content%>">
										</div>
										<div class="mb-3 col-3 col-xl-3">
										</div>
										<div class="mb-3 col-4 col-xl-4 d-flex justify-content-end">
											<form name="searchform" method="get">
												<input type="hidden" id="currentPage" name ="currentPage">
												<input type="hidden" id="pageMove" name ="pageMove">
												<input type="hidden" id="select" name ="select">
												<input type="hidden" id="content" name ="content">
												<button class="ml-1 btn btn-primary btn-mg" onclick="javascript:movePage(''); return false;"><i class="align-middle" data-feather="search"></i> 조회</button>
												<button class="ml-1 btn btn-primary btn-mg" onclick="javascript:addMenu(); return false;"><i class="align-middle" data-feather="plus"></i> 등록</button>
												<button class="ml-1 btn btn-primary btn-mg" onclick="javascript:init(); return false;"><i class="align-middle" data-feather="rotate-ccw"></i> 초기화</button>
											</form>
										</div>
									</div>
							</div>
							<h6 class="card-subtitle text-muted">
								<p class="text-start"></p>
								<p class="text-end">검색결과: <Strong><%=pageVO.getTotal()%></Strong>건, &nbsp;<Strong><%=pageVO.getCurrentPage()%>/<%=pageVO.getTotalPages()%></Strong> 페이지</p>
							</h6>
							<table class="table table-striped table-bordered text-center">
								<colgroup>
									<col width="3%">
									<col width="8%">
									<col width="8%">
									<col width="10%">
									<col width="10%">
									<col width="10%">
									<col width="5%">
								</colgroup>
								<thead>
									<tr>
										<th>번호</th>
										<th>상위메뉴번호</th>
										<th>메뉴번호</th>
										<th>메뉴명</th>
										<th>메뉴설명</th>
										<th>URL</th>
										<th>관리</th>
									</tr>
								</thead>
								<tbody>
									<% for(var i = 0; i < list.length; i++){ %>
										<tr>
											<td><%=(((pageVO.getCurrentPage() - 1) * pageVO.getSize()) + i + 1)%></td>
											<td><%=list[i].UPPER_MENU_NO%></td>
											<td><%=list[i].MENU_NO%></td>
											<td><%=list[i].MENU_NM%></td>
											<td><%=list[i].MENU_DC%></td>
											<td><%=list[i].MENU_URL%></td>
											<td>
												<button class="btn btn-primary btn-sm" onclick="modifyMenu(this); return false;" style="font-size: .4rem;"
												data-menurecord='{"UPPER_MENU_NO":"<%=list[i].UPPER_MENU_NO%>","MENU_NO":"<%=list[i].MENU_NO%>","MENU_NM":"<%=list[i].MENU_NM%>","MENU_DC":"<%=list[i].MENU_DC%>","MENU_URL":"<%=list[i].MENU_URL%>","MENU_ORDR":"<%=list[i].MENU_ORDR%>"}'>
													<i class="align-middle" data-feather="edit-2"></i>
													수정
												</button>
											</td>
										</tr>
									<% } %>
									<% if (list.length == 0) { %>
										<tr>
											<td style="text-align: center;" colspan="5">
												데이터가 존재하지 않습니다.
											</td>
										</tr>
									<% } %>
								</tbody>
							</table>
							<%-include('partials/paging.html') %>
						</div>
                    </div>
				</div>
			</main>
			
			<div class="modal fade" id="defaultModalPrimary" tabindex="-1" aria-hidden="true" style="display: none;">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title ml-1">
								<h4>메뉴 생성</h4>
							</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">

							<div class="card">
								<div class="card-body">
									<form>
										<div class="form-group row">
											<label for="upperNo" class="col-sm-3 col-form-label"><strong>상위메뉴번호 *</strong></label>
											<div class="col-sm-9">
											<input type="text" class="form-control checkInputNull" id="upperNo" placeholder="상위메뉴번호" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" data-alert="상위 메뉴번호를 입력해주세요.">
											</div>
										</div>

										<div class="form-group row">
											<label for="menuNo" class="col-sm-3 col-form-label"><strong>메뉴번호 *</strong></label>
											<div class="col-sm-6">
												<input type="text" class="form-control checkInputNull" id="menuNo" placeholder="메뉴번호" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" data-alert="메뉴번호를 입력해주세요.">
												<code class="hidden">사용할 수 없는 메뉴번호 입니다.</code>
												<code class="code-green hidden">사용할 수 있는 메뉴번호 입니다.</code>
											</div>
											<div class="col-sm-3"> 
													<button class="ml-1 btn btn-primary btn-mg" onclick="checkDuplicatedMenuNo(); return false;"><i class="align-middle" data-feather="search"></i> 중복체크</button>
											</div>
										</div>

										<div class="form-group row">
											<label for="menuNm" class="col-sm-3 col-form-label"><strong>메뉴명 *</strong></label>
											<div class="col-sm-9">
											<input type="text" class="form-control checkInputNull" id="menuNm" placeholder="메뉴명" data-alert="메뉴명을 입력해주세요.">
											</div>
										</div>
										
										<div class="form-group row">
											<label for="menuUrl" class="col-sm-3 col-form-label"><strong>URL *</strong></label>
											<div class="col-sm-9">
											<input type="text" class="form-control checkInputNull" id="menuUrl" placeholder="URL" data-alert="URL을 입력해주세요.">
											</div>
										</div>

										<div class="form-group row">
											<label for="menuDc" class="col-sm-3 col-form-label"><strong>설명</strong></label>
											<div class="col-sm-9">
											<input type="text" class="form-control" id="menuDc" placeholder="설명">
											</div>
										</div>

										<div class="form-group row">
											<label for="MenuOrder" class="col-sm-3 col-form-label"><strong>메뉴순서 *</strong></label>
											<div class="col-sm-9">
											<input type="text" class="form-control checkInputNull" id="menuOrder" placeholder="메뉴순서" data-alert="메뉴순서를 입력해주세요.">
											</div>
										</div>

										<div class="form-group row"></div>
										<div class="row">
											<div class="col-sm-12 text-center">
											<button type="button" class="btn btn-primary" onclick="insertMenu(); return false;"><i class="align-middle" data-feather="save"></i> 저장</button>
											</div>
										</div>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="modal fade" id="defaultModalPrimary2" tabindex="-1" aria-hidden="true">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title ml-1">
								<h4>메뉴 수정</h4>
							</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">

							<div class="card">
								<div class="card-body">
									<form>
										<div class="form-group row">
											<label for="upperNo2" class="col-sm-3 col-form-label"><strong>상위메뉴번호 *</strong></label>
											<div class="col-sm-9">
											<input type="text" class="form-control checkInputNull" id="upperNo2" placeholder="상위메뉴번호" onkeypress="checkNumber();" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" data-alert="상위 메뉴번호를 입력해주세요.">
											</div>
										</div>

										<div class="form-group row">
											<label for="menuNo2" class="col-sm-3 col-form-label"><strong>메뉴번호 *</strong></label>
											<div class="col-sm-9">
											<input type="text" class="form-control checkInputNull disabled" id="menuNo2" placeholder="메뉴번호" readonly>
											</div>
										</div>

										<div class="form-group row">
											<label for="menuNm2" class="col-sm-3 col-form-label"><strong>메뉴명 *</strong></label>
											<div class="col-sm-9">
											<input type="text" class="form-control checkInputNull" id="menuNm2" placeholder="메뉴명"  data-alert="메뉴명을 입력해주세요.">
											</div>
										</div>
										
										<div class="form-group row">
											<label for="menuUrl2" class="col-sm-3 col-form-label"><strong>URL *</strong></label>
											<div class="col-sm-9">
											<input type="text" class="form-control checkInputNull" id="menuUrl2" placeholder="URL" data-alert="URL를 입력해주세요.">
											</div>
										</div>

										<div class="form-group row">
											<label for="menuDc2" class="col-sm-3 col-form-label"><strong>설명</strong></label>
											<div class="col-sm-9">
											<input type="text" class="form-control" id="menuDc2" placeholder="설명">
											</div>
										</div>

										<div class="form-group row">
											<label for="MenuOrder2" class="col-sm-3 col-form-label"><strong>메뉴순서 *</strong></label>
											<div class="col-sm-9">
											<input type="text" class="form-control checkInputNull" id="menuOrder2" placeholder="메뉴순서" data-alert="메뉴순서를 입력해주세요.">
											</div>
										</div>

										<div class="form-group row"></div>
										<div class="row">
											<div class="col-sm-12 text-center">
												<button type="text" class="btn btn-primary" onclick="updateMenu(); return false;"><i class="align-middle" data-feather="save"></i> 수정</button>
												<button type="text" class="ml-1 btn btn-secondary" onclick="deleteMenu(); return false;"><i class="align-middle" data-feather="delete"></i> 삭제</button>
											</div>
										</div>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<footer class="footer">
				<%-include('partials/footer.html') %>
			</footer>
		</div>
	</div>

	<script>
		function addMenu() {
			$("#defaultModalPrimary").modal('toggle');
		}
		function init() {
			$("#searchSelect").val("all");
			$("#searchContent").val("");
			movePage('');
		}
		function checkNumber(event) {
			if(event.key === '.' 
				|| event.key === '-'
				|| event.key >= 0 && event.key <= 9) {
				return true;
			}
			return false;
		}
		function modifyMenu(obj) {
			$("#defaultModalPrimary2").modal('toggle');
			var data = $(obj).data('menurecord');
			console.log(data);
			$("#upperNo2").val(data.UPPER_MENU_NO);
			$("#menuNo2").val(data.MENU_NO);
			$("#menuNm2").val(data.MENU_NM);
			$("#menuDc2").val(data.MENU_DC);
			$("#menuUrl2").val(data.MENU_URL);
			$("#menuOrder2").val(data.MENU_ORDR);
		}
		
		function insertMenu() {
			var nullcheck = checkInputNull();
			if(nullcheck != "") {
				alert(nullcheck);
				return;
			}

			if(currentStatus == status[0]){
				alert("메뉴번호 중복체크를 해주세요.");
				$("#menuNo").focus();
				return;
			}

			$.ajax({
				type:"post",
				url:"/manage/menulist/insertmenu",
				dataType: 'json',
				data : {
					upperNo : $("#upperNo").val(),
					menuNo : $("#menuNo").val(),
					menuNm : $("#menuNm").val(),
					menuDc : $("#menuDc").val(),
					menuUrl : $("#menuUrl").val(),
					menuOrder : $("#menuOrder").val()
				},success : function(data){
					if(data.status == "success") {
						$("#defaultModalPrimary").modal('toggle');
						alert("저장되었습니다.");
						document.location.reload();
					}
				}, error : function() {
				}
			});
		}

		const status = ['notCheck','duplicated', 'notDuplicated'];
		var currentStatus = status[0];

		function checkDuplicatedMenuNo() {
			if($("#menuNo").val().trim() ==  "") {
				alert("메뉴번호를 입력해주세요.");
				return;
			}
			$.ajax({
					type:"get",
					url:"/manage/menulist/checkmenuno",
					dataType: 'json',
					data : {
						menuNo : $("#menuNo").val()
					},
					success : function(data){
						$("#defaultModalPrimary code").hide();
						// 중복
						if(data.status == status[1]) {
							currentStatus = status[1];
							$($("#defaultModalPrimary code").get(0)).show();
						// 사용가능
						} else if(data.status == status[2]) {
							currentStatus = status[2];
							$($("#defaultModalPrimary code").get(1)).show();
						}
					}, error : function(data) {
						alert(data.msg);
					}
				});	
		}

		
		function updateMenu(obj) {
			var nullcheck = checkInputNull2();
			if(nullcheck != "") {
				alert(nullcheck);
				return;
			}
			$.ajax({
					type:"put",
					url:"/manage/menulist/updatemenu",
					dataType: 'json',
					data : {
						upperNo : $("#upperNo2").val(),
						menuNo : $("#menuNo2").val(),
						menuNm : $("#menuNm2").val(),
						menuDc : $("#menuDc2").val(),
						menuUrl : $("#menuUrl2").val(),
						menuOrder : $("#menuOrder2").val()
					},
					success : function(data){
						$("#defaultModalPrimary2").modal('toggle');
						alert("저장되었습니다.");
						document.location.reload();
					}, error : function(data) {
						alert(data.msg);
					}
				});	
		}

		function deleteMenu() {
			if(confirm($("#menuNo2").val() +" 를 삭제 하시겠습니까?")) {
					$.ajax({
						type:"delete",
						url:"/manage/menulist/deletemenu",
						dataType: 'json',
						data : {menuNo : $("#menuNo2").val()},
						success : function(data){
							if(data.status == "success") {
								$("#defaultModalPrimary2").modal('toggle');
								alert("삭제되었습니다.");
								document.location.reload(true);
							}
						}, error : function() {
							$(object).val(preUseYn);
						}
					});
			} else {
				$(object).val(preUseYn);
			}
		}

		function checkInputNull(){
			var result = '';
			$('#defaultModalPrimary .checkInputNull').each(function(index, item) {
				if($(this).val().trim() == "") {
					result = $(this).data("alert");
					return false;
				}
			});
			return result;
		}
		
		function checkInputNull2(){
			var result = '';
			$('#defaultModalPrimary2 .checkInputNull').each(function(index, item) {
				if($(this).val().trim() == "") {
					result = $(this).data("alert");
					return false;
				}
			});
			return result;
		}

		// modal hidden event
		$('#defaultModalPrimary').on('hidden.bs.modal', function () {
			$("#defaultModalPrimary code").hide();
			// 중복체크 초기화
			currentStatus = status[0];
			$('#defaultModalPrimary .checkInputNull').each(function(index, item) {
				$(this).val("");
			});
		})

		function movePage(curPage) {
			document.searchform.currentPage.value = curPage;
			document.searchform.select.value = $("#searchSelect").val().trim();
			document.searchform.content.value = $("#searchContent").val().trim();
			document.searchform.submit();
		}

		function movePagePreNext(curPage, pageState) {
			document.searchform.pageMove.value = pageState;
			document.searchform.currentPage.value = curPage;
			document.searchform.select.value = $("#searchSelect").val().trim();
			document.searchform.conetnt.value = $("#searchContent").val().trim();
			document.searchform.submit();
		}

		function enterkey() {
			if (window.event.keyCode == 13) {
				movePage('');
    		}
		}
	</script>
</body>

</html>